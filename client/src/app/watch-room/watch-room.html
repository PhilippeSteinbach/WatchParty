<div class="watch-room">
  <!-- Toast notifications -->
  @if (notifications().length > 0) {
    <div class="toast-container" aria-live="polite">
      @for (note of notifications(); track $index) {
        <div class="toast">{{ note }}</div>
      }
    </div>
  }

  <header class="toolbar">
    <div class="room-info">
      <span class="room-label">Room:</span>
      <span class="room-code">{{ roomCode() }}</span>
      <button class="copy-btn" (click)="copyLink()">
        {{ linkCopied() ? 'âœ“ Copied' : 'ðŸ“‹ Copy Link' }}
      </button>
      <button class="sync-btn" (click)="requestSync()">ðŸ”„ Sync</button>
    </div>

    <form class="video-form" (ngSubmit)="changeVideo()">
      <input
        type="text"
        placeholder="Paste YouTube URL or playlistâ€¦"
        [ngModel]="videoUrlInput()"
        (ngModelChange)="videoUrlInput.set($event)"
        name="videoUrl"
      />
      <button type="submit">Load</button>
    </form>

    <div class="toolbar-right">
      @if (!webRtc.isActive()) {
        <app-media-controls
          [isActive]="false"
          [isCameraOn]="false"
          [isMicOn]="false"
          (startMedia)="onStartMedia()"
        />
      }
    </div>
  </header>

  @if (webRtc.isActive() || webRtc.remoteStreams().length > 0) {
    <div class="video-grid-area">
      <app-video-grid
        [localStream]="webRtc.localStream()"
        [remoteStreams]="webRtc.remoteStreams()"
        [isCameraOn]="webRtc.isCameraOn()"
        [isMicOn]="webRtc.isMicOn()"
        (toggleCamera)="onToggleCamera()"
        (toggleMic)="onToggleMic()"
        (stopMedia)="onStopMedia()"
      />
    </div>
  }

  <div class="main-content">
    <div class="player-area">
      @if (currentVideoUrl) {
        <div class="youtube-area">
          <app-youtube-player
            [videoUrl]="currentVideoUrl"
            [isPlaying]="isPlaying"
            [currentTime]="currentTime"
            [playbackRate]="playbackRate()"
            [recommendations]="displayRecommendations()"
            (playerEvent)="onPlayerEvent($event)"
            (overlayClick)="onPlayPause()"
            (playRecommendation)="onPlayRecommendation($event)"
            (queueRecommendation)="onQueueRecommendation($event)"
          />
        </div>
        <app-video-controls
          [isPlaying]="isPlaying"
          [currentTime]="polledTime()"
          [duration]="polledDuration()"
          [canControl]="true"
          [hasVideo]="!!currentVideoUrl"
          (playPause)="onPlayPause()"
          (seek)="onSeek($event)"
          (volumeChange)="onVolumeChange($event)"
        />
      } @else {
        <div class="empty-player-placeholder">
          <span class="placeholder-icon" aria-hidden="true">ðŸŽ¬</span>
          <p class="placeholder-text">FÃ¼ge ein Video Ã¼ber die URL-Leiste oben oder die Playlist hinzu, um loszulegen.</p>
        </div>
      }
    </div>

    <aside class="sidebar" [class.collapsed]="sidebarCollapsed()">
      @if (!sidebarCollapsed()) {
        <app-participant-list [participants]="participants()" />
      }
      <div class="tab-bar">
        @if (!sidebarCollapsed()) {
          <button
            class="tab-btn"
            [class.active]="activeTab() === 'playlist'"
            (click)="activeTab.set('playlist')"
          >
            Playlist
          </button>
          <button
            class="tab-btn"
            [class.active]="activeTab() === 'chat'"
            (click)="activeTab.set('chat')"
          >
            Chat
            @if (unreadChatCount() > 0) {
              <span class="unread-badge" aria-label="unread messages">{{ unreadChatCount() }}</span>
            }
          </button>
        }
        <button
          class="sidebar-toggle"
          (click)="sidebarCollapsed.set(!sidebarCollapsed())"
          [attr.aria-label]="sidebarCollapsed() ? 'Expand sidebar' : 'Collapse sidebar'"
        >
          {{ sidebarCollapsed() ? 'â—€' : 'â–¶' }}
        </button>
      </div>
      @if (!sidebarCollapsed()) {
        @if (activeTab() === 'chat') {
          <app-chat-panel />
        } @else {
          <app-playlist-panel />
        }
      }
    </aside>
  </div>

  @if (showPlaylistConfirm()) {
    <app-confirm-dialog
      [message]="playlistConfirmMessage()"
      confirmLabel="Add Videos"
      cancelLabel="Cancel"
      (confirmed)="onConfirmPlaylistImport()"
      (cancelled)="onCancelPlaylistImport()"
    />
  }
</div>
