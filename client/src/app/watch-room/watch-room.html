<div class="watch-room">
  <!-- Toast notifications -->
  @if (notifications().length > 0) {
    <div class="toast-container" aria-live="polite">
      @for (note of notifications(); track $index) {
        <div class="toast bg-surface-4 text-purple-100 shadow-glow-sm border border-border rounded-lg">{{ note }}</div>
      }
    </div>
  }

  <header class="toolbar bg-surface-2">
    <div class="toolbar-top">
      <div class="room-info">
        <span class="text-purple-300/60 text-sm">Room</span>
        <div class="flex items-center gap-1.5">
          <span class="room-code text-neon-purple font-semibold">{{ roomCode() }}</span>
          <button
            class="btn-icon"
            (click)="copyLink()"
            [title]="linkCopied() ? 'Copied!' : 'Copy invite link'"
            [attr.aria-label]="linkCopied() ? 'Link copied' : 'Copy invite link'"
          >
            @if (linkCopied()) {
              <lucide-icon [img]="CheckIcon" [size]="14"></lucide-icon>
            } @else {
              <lucide-icon [img]="CopyIcon" [size]="14"></lucide-icon>
            }
          </button>
        </div>
      </div>

      <div class="toolbar-right">
        @if (webRtc.mediaError(); as error) {
          <span class="text-neon-red text-xs">{{ error }}</span>
        }
        @if (!webRtc.isActive()) {
          <app-media-controls
            [isActive]="false"
            [isCameraOn]="false"
            [isMicOn]="false"
            [disabled]="webRtc.isVideoFull()"
            [disabledReason]="'Video limit reached (max 6)'"
            (startMedia)="onStartMedia()"
          />
        }
      </div>
    </div>

    <form class="video-form" (ngSubmit)="searchVideos()">
      <div class="search-input-wrapper">
        <div class="flex items-center flex-1 input-dark px-2.5 gap-2">
          <svg class="shrink-0 pointer-events-none" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.5 3.5 12 3.5 12 3.5s-7.5 0-9.4.6A3 3 0 0 0 .5 6.2 31.4 31.4 0 0 0 0 12a31.4 31.4 0 0 0 .5 5.8 3 3 0 0 0 2.1 2.1c1.9.6 9.4.6 9.4.6s7.5 0 9.4-.6a3 3 0 0 0 2.1-2.1A31.4 31.4 0 0 0 24 12a31.4 31.4 0 0 0-.5-5.8zM9.6 15.6V8.4l6.3 3.6-6.3 3.6z" class="text-neon-red/60"/>
          </svg>
          <input
            class="bg-transparent border-none outline-none w-full text-sm text-inherit placeholder:text-purple-400/50"
            type="text"
            placeholder="Search YouTube or paste a linkâ€¦"
            [ngModel]="videoUrlInput()"
            (ngModelChange)="videoUrlInput.set($event)"
            (focus)="showSuggestions.set(suggestions().length > 0)"
            (blur)="dismissSuggestions()"
            (keydown)="onSearchInputKeydown($event)"
            name="videoUrl"
            autocomplete="off"
            role="combobox"
            [attr.aria-expanded]="showSuggestions()"
            aria-autocomplete="list"
            aria-controls="search-suggestions"
            [attr.aria-activedescendant]="activeSuggestionIndex() >= 0 ? 'suggestion-' + activeSuggestionIndex() : null"
          />
          @if (videoUrlInput()) {
            <button
              class="search-inline-btn"
              type="button"
              aria-label="Clear search"
              (click)="videoUrlInput.set(''); clearSearch()"
            >
              <lucide-icon [img]="XIcon" [size]="16"></lucide-icon>
            </button>
          }
          <button
            class="search-inline-btn"
            type="submit"
            aria-label="Search"
          >
            <lucide-icon [img]="SearchIcon" [size]="16"></lucide-icon>
          </button>
        </div>
        @if (showSuggestions() && suggestions().length > 0) {
          <ul class="suggestions-dropdown" id="search-suggestions" role="listbox">
            @for (s of suggestions(); track s; let i = $index) {
              <li
                role="option"
                [id]="'suggestion-' + i"
                [class.active]="i === activeSuggestionIndex()"
                [attr.aria-selected]="i === activeSuggestionIndex()"
                (mousedown)="selectSuggestion(s)"
                (mouseenter)="activeSuggestionIndex.set(i)"
              >
                <lucide-icon [img]="SearchIcon" [size]="14" class="text-purple-400/40"></lucide-icon>
                <span>{{ s }}</span>
              </li>
            }
          </ul>
        }
      </div>
    </form>
  </header>

  @if (webRtc.isActive() || webRtc.remoteStreams().length > 0) {
    <div class="video-grid-area bg-surface-1 border-b border-border">
      <app-video-grid
        [localStream]="webRtc.localStream()"
        [remoteStreams]="webRtc.remoteStreams()"
        [isCameraOn]="webRtc.isCameraOn()"
        [isMicOn]="webRtc.isMicOn()"
        (toggleCamera)="onToggleCamera()"
        (toggleMic)="onToggleMic()"
        (stopMedia)="onStopMedia()"
      />
    </div>
  }

  <div class="main-content">
    <div class="player-area bg-surface-0" #playerArea>
      <div #playerTop></div>
      @if (currentVideoUrl) {
        <div class="youtube-area">
          <app-youtube-player
            [videoUrl]="currentVideoUrl"
            [isPlaying]="isPlaying"
            [currentTime]="currentTime"
            [playbackRate]="playbackRate()"
            [recommendations]="displayRecommendations()"
            (playerEvent)="onPlayerEvent($event)"
            (overlayClick)="onPlayPause()"
            (playRecommendation)="onPlayRecommendation($event)"
            (queueRecommendation)="onQueueRecommendation($event)"
          />
        </div>
        <app-video-controls
          [isPlaying]="isPlaying"
          [currentTime]="polledTime()"
          [duration]="polledDuration()"
          [canControl]="true"
          [hasVideo]="!!currentVideoUrl"
          (playPause)="onPlayPause()"
          (seek)="onSeek($event)"
          (volumeChange)="onVolumeChange($event)"
        />
      } @else {
        <div class="empty-player-placeholder">
          <lucide-icon class="text-purple-400/30" [img]="FilmIcon" [size]="48" aria-hidden="true"></lucide-icon>
          <p class="text-purple-300/40 text-sm max-w-[360px] text-center leading-relaxed m-0">
            Search for a video above to get started.
          </p>
        </div>
      }

      <!-- Search results area -->
      <div #searchResultsArea>
        @if (searchResults().length > 0 || isSearching()) {
          <div class="search-results-header">
            <span class="text-purple-300/60 text-sm">Search Results</span>
            <button class="btn-ghost text-xs px-2 py-1" (click)="clearSearch()">Clear</button>
          </div>
          <app-search-results
            [results]="searchResults()"
            [isLoading]="isSearching()"
            (playNow)="onSearchPlayNow($event)"
            (addToPlaylist)="onSearchAddToPlaylist($event)"
          />
        } @else {
          <div class="scroll-hint">
            <span class="text-purple-400/20 text-xs">Search for videos to see results here</span>
          </div>
        }
      </div>
    </div>

    <aside class="sidebar bg-surface-2 border-l border-border" [class.collapsed]="sidebarCollapsed()">
      @if (!sidebarCollapsed()) {
        <app-participant-list [participants]="participants()" />
      }
      <div class="tab-bar">
        @if (!sidebarCollapsed()) {
          <button
            class="tab-btn"
            [class.active]="activeTab() === 'playlist'"
            (click)="activeTab.set('playlist')"
          >
            Playlist
          </button>
          <button
            class="tab-btn"
            [class.active]="activeTab() === 'chat'"
            (click)="activeTab.set('chat')"
          >
            Chat
            @if (unreadChatCount() > 0) {
              <span class="unread-badge bg-neon-pink text-white" aria-label="unread messages">{{ unreadChatCount() }}</span>
            }
          </button>
        }
        <button
          class="sidebar-toggle"
          (click)="sidebarCollapsed.set(!sidebarCollapsed())"
          [attr.aria-label]="sidebarCollapsed() ? 'Expand sidebar' : 'Collapse sidebar'"
        >
          @if (sidebarCollapsed()) {
            <lucide-icon [img]="PanelLeftOpenIcon" [size]="16"></lucide-icon>
          } @else {
            <lucide-icon [img]="PanelLeftCloseIcon" [size]="16"></lucide-icon>
          }
        </button>
      </div>
      @if (!sidebarCollapsed()) {
        @if (activeTab() === 'chat') {
          <app-chat-panel />
        } @else {
          <app-playlist-panel />
        }
      }
    </aside>
  </div>

  @if (showPlaylistConfirm()) {
    <app-confirm-dialog
      [message]="playlistConfirmMessage()"
      confirmLabel="Add Videos"
      cancelLabel="Cancel"
      (confirmed)="onConfirmPlaylistImport()"
      (cancelled)="onCancelPlaylistImport()"
    />
  }
</div>
