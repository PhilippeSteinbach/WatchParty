<div class="watch-room">
  <!-- Toast notifications -->
  @if (notifications().length > 0) {
    <div class="toast-container" aria-live="polite">
      @for (note of notifications(); track $index) {
        <div class="toast bg-surface-4 text-purple-100 shadow-glow-sm border border-border rounded-lg">{{ note }}</div>
      }
    </div>
  }

  <header class="toolbar bg-surface-2">
    <div class="room-info">
      <span class="text-purple-300/60 text-sm">Room:</span>
      <span class="text-neon-purple font-semibold">{{ roomCode() }}</span>
      <button class="btn-ghost flex items-center gap-1.5 px-2.5 py-1 text-xs" (click)="copyLink()">
        @if (linkCopied()) {
          <lucide-icon [img]="CheckIcon" [size]="14"></lucide-icon>
          <span>Copied</span>
        } @else {
          <lucide-icon [img]="CopyIcon" [size]="14"></lucide-icon>
          <span>Copy Link</span>
        }
      </button>
    </div>

    <form class="video-form" (ngSubmit)="addVideo()">
      <div class="relative flex-1 max-w-sm">
        <svg class="absolute left-2.5 top-1/2 -translate-y-1/2 pointer-events-none" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.5 3.5 12 3.5 12 3.5s-7.5 0-9.4.6A3 3 0 0 0 .5 6.2 31.4 31.4 0 0 0 0 12a31.4 31.4 0 0 0 .5 5.8 3 3 0 0 0 2.1 2.1c1.9.6 9.4.6 9.4.6s7.5 0 9.4-.6a3 3 0 0 0 2.1-2.1A31.4 31.4 0 0 0 24 12a31.4 31.4 0 0 0-.5-5.8zM9.6 15.6V8.4l6.3 3.6-6.3 3.6z" class="text-neon-red/60"/>
        </svg>
        <input
          class="input-dark w-full text-sm pl-8"
          type="text"
          placeholder="Paste YouTube URL or playlist…"
          [ngModel]="videoUrlInput()"
          (ngModelChange)="videoUrlInput.set($event)"
          name="videoUrl"
        />
      </div>
      <button class="btn-gradient px-4 py-2 text-sm" type="submit">Add</button>
    </form>

    <div class="toolbar-right">
      @if (webRtc.mediaError(); as error) {
        <span class="text-neon-red text-xs">{{ error }}</span>
      }
      @if (!webRtc.isActive()) {
        <app-media-controls
          [isActive]="false"
          [isCameraOn]="false"
          [isMicOn]="false"
          [disabled]="webRtc.isVideoFull()"
          [disabledReason]="'Video limit reached (max 6)'"
          (startMedia)="onStartMedia()"
        />
      }
    </div>
  </header>

  @if (webRtc.isActive() || webRtc.remoteStreams().length > 0) {
    <div class="video-grid-area bg-surface-1 border-b border-border">
      <app-video-grid
        [localStream]="webRtc.localStream()"
        [remoteStreams]="webRtc.remoteStreams()"
        [isCameraOn]="webRtc.isCameraOn()"
        [isMicOn]="webRtc.isMicOn()"
        (toggleCamera)="onToggleCamera()"
        (toggleMic)="onToggleMic()"
        (stopMedia)="onStopMedia()"
      />
    </div>
  }

  <div class="main-content">
    <div class="player-area bg-surface-0">
      @if (currentVideoUrl) {
        <div class="youtube-area">
          <app-youtube-player
            [videoUrl]="currentVideoUrl"
            [isPlaying]="isPlaying"
            [currentTime]="currentTime"
            [playbackRate]="playbackRate()"
            [recommendations]="displayRecommendations()"
            (playerEvent)="onPlayerEvent($event)"
            (overlayClick)="onPlayPause()"
            (playRecommendation)="onPlayRecommendation($event)"
            (queueRecommendation)="onQueueRecommendation($event)"
          />
        </div>
        <app-video-controls
          [isPlaying]="isPlaying"
          [currentTime]="polledTime()"
          [duration]="polledDuration()"
          [canControl]="true"
          [hasVideo]="!!currentVideoUrl"
          (playPause)="onPlayPause()"
          (seek)="onSeek($event)"
          (volumeChange)="onVolumeChange($event)"
        />
      } @else {
        <div class="empty-player-placeholder">
          <lucide-icon class="text-purple-400/30" [img]="FilmIcon" [size]="48" aria-hidden="true"></lucide-icon>
          <p class="text-purple-300/40 text-sm max-w-[360px] text-center leading-relaxed m-0">
            Füge ein Video über die URL-Leiste oben oder die Playlist hinzu, um loszulegen.
          </p>
        </div>
      }
    </div>

    <aside class="sidebar bg-surface-2 border-l border-border" [class.collapsed]="sidebarCollapsed()">
      @if (!sidebarCollapsed()) {
        <app-participant-list [participants]="participants()" />
      }
      <div class="tab-bar">
        @if (!sidebarCollapsed()) {
          <button
            class="tab-btn"
            [class.active]="activeTab() === 'playlist'"
            (click)="activeTab.set('playlist')"
          >
            Playlist
          </button>
          <button
            class="tab-btn"
            [class.active]="activeTab() === 'chat'"
            (click)="activeTab.set('chat')"
          >
            Chat
            @if (unreadChatCount() > 0) {
              <span class="unread-badge bg-neon-pink text-white" aria-label="unread messages">{{ unreadChatCount() }}</span>
            }
          </button>
        }
        <button
          class="sidebar-toggle"
          (click)="sidebarCollapsed.set(!sidebarCollapsed())"
          [attr.aria-label]="sidebarCollapsed() ? 'Expand sidebar' : 'Collapse sidebar'"
        >
          @if (sidebarCollapsed()) {
            <lucide-icon [img]="PanelLeftOpenIcon" [size]="16"></lucide-icon>
          } @else {
            <lucide-icon [img]="PanelLeftCloseIcon" [size]="16"></lucide-icon>
          }
        </button>
      </div>
      @if (!sidebarCollapsed()) {
        @if (activeTab() === 'chat') {
          <app-chat-panel />
        } @else {
          <app-playlist-panel />
        }
      }
    </aside>
  </div>

  @if (showPlaylistConfirm()) {
    <app-confirm-dialog
      [message]="playlistConfirmMessage()"
      confirmLabel="Add Videos"
      cancelLabel="Cancel"
      (confirmed)="onConfirmPlaylistImport()"
      (cancelled)="onCancelPlaylistImport()"
    />
  }
</div>
