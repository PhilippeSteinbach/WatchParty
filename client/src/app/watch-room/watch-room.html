<div class="watch-room">
  <!-- Toast notifications -->
  @if (notifications().length > 0) {
    <div class="toast-container" aria-live="polite">
      @for (note of notifications(); track $index) {
        <div class="toast bg-surface-4 text-purple-100 shadow-glow-sm border border-border rounded-lg">{{ note }}</div>
      }
    </div>
  }

  <header class="toolbar bg-surface-2">
    <div class="room-info">
      <span class="text-purple-300/60 text-sm">Room:</span>
      <span class="text-neon-purple font-semibold">{{ roomCode() }}</span>
      <button class="btn-ghost flex items-center gap-1.5 px-2.5 py-1 text-xs" (click)="copyLink()">
        @if (linkCopied()) {
          <lucide-icon [img]="CheckIcon" [size]="14"></lucide-icon>
          <span>Copied</span>
        } @else {
          <lucide-icon [img]="CopyIcon" [size]="14"></lucide-icon>
          <span>Copy Link</span>
        }
      </button>
    </div>

    <form class="video-form" (ngSubmit)="addVideo()">
      <input
        class="input-dark flex-1 max-w-sm text-sm"
        type="text"
        placeholder="Paste YouTube URL or playlist…"
        [ngModel]="videoUrlInput()"
        (ngModelChange)="videoUrlInput.set($event)"
        name="videoUrl"
      />
      <button class="btn-gradient px-4 py-2 text-sm" type="submit">Add</button>
    </form>

    <div class="toolbar-right">
      @if (!webRtc.isActive()) {
        <app-media-controls
          [isActive]="false"
          [isCameraOn]="false"
          [isMicOn]="false"
          (startMedia)="onStartMedia()"
        />
      }
    </div>
  </header>

  @if (webRtc.isActive() || webRtc.remoteStreams().length > 0) {
    <div class="video-grid-area bg-surface-1 border-b border-border">
      <app-video-grid
        [localStream]="webRtc.localStream()"
        [remoteStreams]="webRtc.remoteStreams()"
        [isCameraOn]="webRtc.isCameraOn()"
        [isMicOn]="webRtc.isMicOn()"
        (toggleCamera)="onToggleCamera()"
        (toggleMic)="onToggleMic()"
        (stopMedia)="onStopMedia()"
      />
    </div>
  }

  <div class="main-content">
    <div class="player-area bg-surface-0">
      @if (currentVideoUrl) {
        <div class="youtube-area">
          <app-youtube-player
            [videoUrl]="currentVideoUrl"
            [isPlaying]="isPlaying"
            [currentTime]="currentTime"
            [playbackRate]="playbackRate()"
            [recommendations]="displayRecommendations()"
            (playerEvent)="onPlayerEvent($event)"
            (overlayClick)="onPlayPause()"
            (playRecommendation)="onPlayRecommendation($event)"
            (queueRecommendation)="onQueueRecommendation($event)"
          />
        </div>
        <app-video-controls
          [isPlaying]="isPlaying"
          [currentTime]="polledTime()"
          [duration]="polledDuration()"
          [canControl]="true"
          [hasVideo]="!!currentVideoUrl"
          (playPause)="onPlayPause()"
          (seek)="onSeek($event)"
          (volumeChange)="onVolumeChange($event)"
        />
      } @else {
        <div class="empty-player-placeholder">
          <lucide-icon class="text-purple-400/30" [img]="FilmIcon" [size]="48" aria-hidden="true"></lucide-icon>
          <p class="text-purple-300/40 text-sm max-w-[360px] text-center leading-relaxed m-0">
            Füge ein Video über die URL-Leiste oben oder die Playlist hinzu, um loszulegen.
          </p>
        </div>
      }
    </div>

    <aside class="sidebar bg-surface-2 border-l border-border" [class.collapsed]="sidebarCollapsed()">
      @if (!sidebarCollapsed()) {
        <app-participant-list [participants]="participants()" />
      }
      <div class="tab-bar">
        @if (!sidebarCollapsed()) {
          <button
            class="tab-btn"
            [class.active]="activeTab() === 'playlist'"
            (click)="activeTab.set('playlist')"
          >
            Playlist
          </button>
          <button
            class="tab-btn"
            [class.active]="activeTab() === 'chat'"
            (click)="activeTab.set('chat')"
          >
            Chat
            @if (unreadChatCount() > 0) {
              <span class="unread-badge bg-neon-pink text-white" aria-label="unread messages">{{ unreadChatCount() }}</span>
            }
          </button>
        }
        <button
          class="sidebar-toggle"
          (click)="sidebarCollapsed.set(!sidebarCollapsed())"
          [attr.aria-label]="sidebarCollapsed() ? 'Expand sidebar' : 'Collapse sidebar'"
        >
          @if (sidebarCollapsed()) {
            <lucide-icon [img]="PanelLeftOpenIcon" [size]="16"></lucide-icon>
          } @else {
            <lucide-icon [img]="PanelLeftCloseIcon" [size]="16"></lucide-icon>
          }
        </button>
      </div>
      @if (!sidebarCollapsed()) {
        @if (activeTab() === 'chat') {
          <app-chat-panel />
        } @else {
          <app-playlist-panel />
        }
      }
    </aside>
  </div>

  @if (showPlaylistConfirm()) {
    <app-confirm-dialog
      [message]="playlistConfirmMessage()"
      confirmLabel="Add Videos"
      cancelLabel="Cancel"
      (confirmed)="onConfirmPlaylistImport()"
      (cancelled)="onCancelPlaylistImport()"
    />
  }
</div>
